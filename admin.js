const ADMIN_PIN_DEFAULT='1234';const state={authed:false,cats:[],prods:[]};const panel=document.getElementById('panel');const authStatus=document.getElementById('authStatus');const pinInput=document.getElementById('pinInput');document.getElementById('btnLogin').addEventListener('click',()=>{if((pinInput.value||'')!==''){state.authed=true;authStatus.textContent='Acesso liberado.';panel.hidden=false;}else{authStatus.textContent='Digite o PIN.';}});document.getElementById('btnFetch').addEventListener('click',async()=>{const cats=await (await fetch('/api/db?table=categories')).json();const prods=await (await fetch('/api/db?table=products')).json();state.cats=cats;state.prods=prods;renderCats();renderProds();});document.getElementById('btnExportCats').addEventListener('click',()=>downloadJSON('categories.json',state.cats));document.getElementById('btnExportProds').addEventListener('click',()=>downloadJSON('products.json',state.prods));document.getElementById('btnSaveCats').addEventListener('click',async()=>{if(await saveTable('categories',state.cats))alert('Categorias salvas!');});document.getElementById('btnSaveProds').addEventListener('click',async()=>{if(await saveTable('products',state.prods))alert('Produtos salvos!');});async function saveTable(table,data){const res=await fetch('/api/db?table='+table,{method:'PUT',headers:{'Content-Type':'application/json','x-admin-pin':pinInput.value||ADMIN_PIN_DEFAULT},body:JSON.stringify(data,null,2)});if(!res.ok){alert('Erro ao salvar: '+(await res.text()));return false;}return true;}function downloadJSON(name,data){const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);}function renderCats(){const box=document.getElementById('catsList');if(!state.cats?.length){box.innerHTML='<p class="muted">Nenhuma categoria.</p>';return;}box.innerHTML='';state.cats.forEach((c,i)=>{const line=document.createElement('div');line.className='row-line';line.innerHTML=`<div><div><strong>${esc(c.label||'')}</strong> <span class='badge'>/${esc(c.slug||'')}</span></div><div class='badge'>${c.previewImage?'preview ✓':'preview —'} • ${esc(c.colorClass||'')}</div></div><button class='icon-btn' data-edit='${i}'>Editar</button><button class='icon-btn' data-del='${i}'>Excluir</button>`;line.querySelector('[data-edit]').onclick=()=>openCatModal(i);line.querySelector('[data-del]').onclick=()=>{if(confirm('Excluir categoria?')){state.cats.splice(i,1);renderCats();}};box.appendChild(line);});}function renderProds(){const box=document.getElementById('prodsList');if(!state.prods?.length){box.innerHTML='<p class="muted">Nenhum produto.</p>';return;}box.innerHTML='';state.prods.forEach((p,i)=>{const line=document.createElement('div');line.className='row-line';line.innerHTML=`<div><div><strong>${esc(p.title||'')}</strong> <span class='badge'>${esc(p.category||'')}</span></div><div class='badge'>${esc(p.price||'')}</div></div><button class='icon-btn' data-edit='${i}'>Editar</button><button class='icon-btn' data-del='${i}'>Excluir</button>`;line.querySelector('[data-edit]').onclick=()=>openProdModal(i);line.querySelector('[data-del]').onclick=()=>{if(confirm('Excluir produto?')){state.prods.splice(i,1);renderProds();}};box.appendChild(line);});}document.getElementById('btnAddCat').onclick=()=>openCatModal(null);document.getElementById('btnAddProd').onclick=()=>openProdModal(null);const modal=document.getElementById('modal');const modalTitle=document.getElementById('modalTitle');const modalBody=document.getElementById('modalBody');const modalForm=document.getElementById('modalForm');function openCatModal(index){const cat=index==null?{label:'',slug:'',previewImage:'',colorClass:'',desc:''}:JSON.parse(JSON.stringify(state.cats[index]));modalTitle.textContent=index==null?'Nova categoria':'Editar categoria';modalBody.innerHTML=`<label>Nome (label)<input class='input' id='f_label' value='${esc(cat.label)}'></label><label>Slug<input class='input' id='f_slug' value='${esc(cat.slug)}'><small>ex.: casa-e-decoracao</small></label><label>Imagem de preview (URL)<input class='input' id='f_prev' value='${esc(cat.previewImage)}'></label><label>Classe de cor<input class='input' id='f_color' value='${esc(cat.colorClass||'')}'><small>casa/beleza/roupas/livros (ou crie no CSS)</small></label><label>Descrição<textarea class='input' id='f_desc' rows='3'>${esc(cat.desc||'')}</textarea></label>`;modal.showModal();modalForm.onsubmit=e=>{e.preventDefault();const updated={label:val('f_label'),slug:val('f_slug'),previewImage:val('f_prev'),colorClass:val('f_color'),desc:val('f_desc')};if(index==null)state.cats.push(updated);else state.cats[index]=updated;renderCats();modal.close();};}function openProdModal(index){const p=index==null?{id:'',title:'',category:'',categorySlug:'',price:'',links:{},primaryLink:''}:JSON.parse(JSON.stringify(state.prods[index]));modalTitle.textContent=index==null?'Novo produto':'Editar produto';modalBody.innerHTML=`<label>Título<input class='input' id='p_title' value='${esc(p.title)}'></label><label>Categoria (label)<input class='input' id='p_cat' value='${esc(p.category)}'></label><label>Slug da categoria<input class='input' id='p_cslug' value='${esc(p.categorySlug||'')}'></label><label>Preço<input class='input' id='p_price' value='${esc(p.price||'')}'></label><label>Link principal<input class='input' id='p_plink' value='${esc(p.primaryLink||'')}'></label><fieldset class='stack'><legend>Links (opcionais)</legend><label>Shopee<input class='input' id='p_l_shopee' value='${esc(p.links?.shopee||'')}'></label><label>AliExpress<input class='input' id='p_l_aliexpress' value='${esc(p.links?.aliexpress||'')}'></label><label>Amazon<input class='input' id='p_l_amazon' value='${esc(p.links?.amazon||'')}'></label></fieldset>`;modal.showModal();modalForm.onsubmit=e=>{e.preventDefault();const updated={id:p.id||crypto.randomUUID(),title:val('p_title'),category:val('p_cat'),categorySlug:val('p_cslug'),price:val('p_price'),primaryLink:val('p_plink'),links:{shopee:val('p_l_shopee'),aliexpress:val('p_l_aliexpress'),amazon:val('p_l_amazon')}};if(index==null)state.prods.push(updated);else state.prods[index]=updated;renderProds();modal.close();};}function val(id){return document.getElementById(id)?.value?.trim()||'';}function esc(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}